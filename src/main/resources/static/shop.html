<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ğŸŠä¹¦åº—</title>
    <link rel="stylesheet" href="css/shop.css">
    <script type="text/javascript" src="./script/vue.global.js"></script>
    <script type="text/javascript" src="./script/axios.js"></script>
</head>

<body>
<div id="bookshopapp">
    <div id="top">
        <div id="top-left">
            <div id="top-left-logo">ğŸ“–</div>
            <div id="top-left-name">ğŸŠä¹¦åº—</div>
        </div>
        <div id="top-right">
            <div id="top-right-login">
                ğŸ‘¨â€ğŸ’»
            </div>
        </div>
    </div>
    <div id="mid">
        <div id="mid-left">
            <div id="mid-left-categroy">
                <ul>
                    <li @click="GetAllBooks()">å…¨éƒ¨</li>
                    <li v-for="category in bcategorys" @click="QueryACategoryBooks(category.bcno)">
                        {{category.categoryName}}
                    </li>
                </ul>
            </div>
        </div>
        <div id="mid-right">
            <div id="mid-right-content">
                <ul>
                    <li v-for="bookUnit in bookUnits">
                        <div id="book-unit">
                            <div id="book-unit-img">
                                <img v-bind:src="bookUnit.burl" alt="fengmian">
                            </div>
                            <div id="book-unit-info">
                                <span style="font-weight: bolder;">{{bookUnit.bname}}</span>
                                <span>ä½œè€…:{{bookUnit.bauthor}}</span>
                                <span>å‡ºç‰ˆæ—¥æœŸ:{{bookUnit.bpubdate}}</span>
                            </div>
                            <div id="book-unit-text">
                                <div id="book-unit-text-content"><b>ç®€ä»‹:</b>{{bookUnit.binfo}}</div>
                            </div>
                            <div id="book-unit-btn" @click="PutCart(bookUnit.bno)">
                                åŠ <br>è´­<br>ç‰©<br>è½¦
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div id="cart">
        <div id="cart-content" v-if="cartVisable">
            <div id="cart-content-bar">
                <span>è´­ç‰©è½¦</span>
                <span>å…±è®¡:</span>
                <span>{{totalOrderPrice}}å…ƒ</span>
                <div @click="CloseCart()"></div>
            </div>
            <ul id="cart-content-ul">
                <li v-for="cartUnit in cartUnits">
                    <div id="cart-data-unit">
                        <span style="width: 40%;">{{cartUnit.bname}}</span>
                        <span style="width: 33%;">{{cartUnit.bauthor}}</span>
                        <span style="width: 10%;">{{cartUnit.bprice}}</span>
                        <div id="cart-data-unit-del" @click="DelCartItem(cartUnit.bno)">
                            åˆ é™¤
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <div id="service-content">
        <button id="buy-button" @click="Buy()" v-show="buyBtnVisable">Buy</button>
        <button id="cart-button" @click="OpenCart()">+</button>
    </div>
    <div id="notice" v-if="noticeVisable">
        <div id="notice-top">
            <h1>ğŸ“ƒå…¬å‘Š</h1>
            <div id="notice-close-btn" @click="CloseNotice()">
            </div>
        </div>
        <div id="notice-info">
            <h1>{{noticeUnit.noticeTitle}}</h1>
            <h3>æ—¥æœŸ:{{noticeUnit.noticeDate}}</h3>
        </div>
        <div id="notice-content">
            {{noticeUnit.noticeContent}}
        </div>
    </div>
</div>
<script>
    const bookshopapp = Vue.createApp({
        data() {
            return {
                bcategorys:[""],
                bookUnits:[""],
                cartUnits:[""],
                cartVisable:false,
                buyBtnVisable:false,
                noticeUnit:{},
                noticeVisable:true,
                totalOrderPrice:0
            }
        },
        mounted()
        {
            //è¯·æ±‚shopé¡µæ•°æ®===============================
            axios({
                url:"BookShopServlet"
            })
                .then((result) => {
                    let data = result.data;
                    this.bcategorys = data.bookCategoryList;
                    this.bookUnits = data.bookUnitList;
                    this.cartUnits = data.cartUnitList;
                    QueryNotice();

                }).catch((err) => {
                console.log("åˆå§‹åŒ–å‡ºé”™äº†");
                console.log(err);
            });
            let thisObj = this;
            function QueryNotice()
            {
                //è¯·æ±‚å…¬å‘Š===========================
                axios({
                    url:"RandomNoticeServlet"
                })
                    .then((result) => {
                        let data = result.data;
                        console.log(data);
                        thisObj.noticeUnit = data;

                    }).catch((err) => {
                    console.log("å‡ºé”™äº†");
                    console.log(err);
                });
            }
            this.OpenCart();

        },
        methods: {
            QueryACategoryBooks(mbcno)
            {
                console.log(mbcno);
                axios({
                    url:"GetCategoryBooksServlet",
                    params:
                        {
                            bcno:mbcno
                        }
                })
                    .then((result) => {
                        let data = result.data;
                        console.log(data);
                        this.bookUnits =data;

                    }).catch((err) => {
                    console.log("è¯·æ±‚ä¸€ä¸ªç±»å‹çš„ä¹¦-å‡ºé”™äº†");
                    console.log(err);
                });
            },
            DelCartItem(mbno)
            {
                axios({
                    url:"RemoveCartServlet",
                    params:
                        {
                            bno:mbno
                        }
                })
                    .then((result) => {
                        let data = result.data;
                        console.log(data);
                        this.cartUnits =data;

                    }).catch((err) => {
                    console.log("è¯·æ±‚è´­ç‰©è½¦ç‰©å“--å‡ºé”™äº†");
                    console.log(err);
                });

            },
            CloseCart()
            {
                this.cartVisable = false;
                this.buyBtnVisable= false;
            },
            OpenCart()
            {
                this.cartVisable = true;
                this.buyBtnVisable= true;
            },
            PutCart(mbno)
            {
                axios({
                    url:"PutCartServlet",
                    params:
                        {
                            bno:mbno
                        }
                })
                    .then((result) => {
                        let data = result.data;
                        console.log(data);
                        this.cartUnits =data;

                    }).catch((err) => {
                    console.log("è¯·æ±‚æ·»åŠ åˆ°è´­ç‰©è½¦--å‡ºé”™äº†");
                    console.log(err);
                });

            },
            Buy()
            {
                axios({
                    url:"OrderServlet",
                    method:'post',
                    data:
                        {
                            buyUnits:this.cartUnits
                        }
                })
                    .then((result) => {
                        //TODO
                    }).catch((err) => {
                    console.log("è¯·æ±‚æäº¤è®¢å•--å‡ºé”™äº†");
                    console.log(err);
                });

                alert("æäº¤è®¢å•æˆåŠŸ,å…±è®¡"+this.totalOrderPrice+"å…ƒ");
            },
            CloseNotice()
            {
                this.noticeVisable = false;
            },
            GetAllBooks()
            {
                axios({
                    url:"getallfruit",
                    method:'get',
                    data:
                        {
                        }
                })
                    .then((result) => {
                        let data = result.data;
                        this.bookUnits = data;
                    }).catch((err) => {
                    console.log("è·å–æ‰€æœ‰ä¹¦ç±å‡ºé”™äº†");
                    console.log(err);
                });
            }
        },
        watch: {
            cartUnits(newcartUnits, oldcartUnits) {
                console.log("è´­ç‰©è½¦æ•°æ®æœ‰å˜åŒ–,é‡æ–°è®¡ç®—æ€»ä»·æ ¼");
                this.totalOrderPrice = 0;
                for(let i = 0; i < newcartUnits.length; i++)
                {
                    this.totalOrderPrice = this.totalOrderPrice + this.cartUnits[i].bprice;
                }
            }
        }

    });

    bookshopapp.mount("#bookshopapp");
</script>
</body>

</html>