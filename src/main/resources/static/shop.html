<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ğŸç½‘ä¸Šæ°´æœåº—</title>
    <link rel="stylesheet" href="css/shop.css">
    <script type="text/javascript" src="./script/vue.global.js"></script>
    <script type="text/javascript" src="./script/axios.js"></script>
</head>

<body>
<div id="fruitshopapp">
    <div id="top">
        <div id="top-left">
            <div id="top-left-logo">ğŸ‰</div>
            <div id="top-left-name">æ°´æœåº—</div>
        </div>
        <div id="top-right">
            <div id="top-right-login">
                ğŸ‘¨â€ğŸ’»
            </div>
        </div>
    </div>
    <div id="mid">
        <div id="mid-left">
            <div id="mid-left-categroy">
                <ul>
                    <li @click="GetAllBooks()">å…¨éƒ¨</li>
                    <li v-for="category in fcategorys" @click="QueryACategoryFruits(category.fcno)">
                        {{category.categoryName}}
                    </li>
                </ul>
            </div>
        </div>
        <div id="mid-right">
            <div id="mid-right-content">
                <ul>
                    <li v-for="fruitUnit in fruitUnits">
                        <div id="fruit-unit">
                            <div id="fruit-unit-img">
                                <img v-bind:src="fruitUnit.furl" alt="fengmian">
                            </div>
                            <div id="fruit-unit-info">
                                <span style="font-weight: bolder;">{{fruitUnit.fname}}</span>
                                <span>ç§ç±»:{{fruitUnit.fcategory}}</span>
                                <span>ä¸Šæ¶æ—¥æœŸ:{{fruitUnit.fpubdate}}</span>
                            </div>
                            <div id="fruit-unit-text">
                                <div id="fruit-unit-text-content"><b>ç®€ä»‹:</b>{{fruitUnit.finfo}}</div>
                            </div>
                            <div id="fruit-unit-btn" @click="PutCart(fruitUnit)">
                                åŠ <br>è´­<br>ç‰©<br>è½¦
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div id="cart">
        <div id="cart-content" v-if="cartVisable">
            <div id="cart-content-bar">
                <span>è´­ç‰©è½¦</span>
                <span>å…±è®¡:</span>
                <span>{{totalOrderPrice}}å…ƒ</span>
                <div @click="CloseCart()"></div>
            </div>
            <ul id="cart-content-ul">
                <li v-for="cartUnit in cartUnits">
                    <div id="cart-data-unit">
                        <span style="width: 40%;">{{cartUnit.data.fname}}</span>
                        <span style="width: 10%;">{{cartUnit.count}}</span>
                        <div id="cart-data-unit-del" @click="DelCartItem(cartUnit.data.fno)">
                            åˆ é™¤
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <div id="service-content">
        <button id="buy-button" @click="Buy()" v-show="buyBtnVisable">Buy</button>
        <button id="cart-button" @click="OpenCart()">+</button>
    </div>
</div>
<script>
    const fruitshopapp = Vue.createApp({
        data() {
            return {
                fcategorys:[],
                fruitUnits:[],
                cartUnits:[],
                cartVisable:false,
                buyBtnVisable:false,
                totalOrderPrice:0
            }
        },
        mounted()
        {
            //===========================è¯·æ±‚shopé¡µæ•°æ®===============================
            axios({
                url:"shop"
            }).then((result) => {
                    let data = result.data;
                    this.fcategorys = data.fruitCategoryList;
                    this.fruitUnits = data.fruitUnitList;

                })
                .catch((err) => {
                    console.log("åˆå§‹åŒ–å‡ºé”™äº†");
                console.log(err);
            });
            this.OpenCart();
        },
        methods: {
            QueryACategoryFruits(mfcno)
            {
                console.log(mfcno);
                axios({
                    url:"getacategoryfruit",
                    params:
                        {
                            fcno:mfcno
                        }
                })
                    .then((result) => {
                        let data = result.data;
                        console.log(data);
                        this.fruitUnits =data;

                    }).catch((err) => {
                    console.log("è¯·æ±‚ä¸€ä¸ªç±»å‹çš„æ°´æœ-å‡ºé”™äº†");
                    console.log(err);
                });
            },
            DelCartItem(mfno)
            {
                let mdata = this.cartUnits;
                for (var i = mdata.length - 1; i >= 0; i--)
                {
                    if (mdata[i].data.fno === mfno) {
                        mdata[i].count--;
                        if(mdata[i].count<=0)
                            mdata.splice(i, 1);
                    }
                }

            },
            CloseCart()
            {
                this.cartVisable = false;
                this.buyBtnVisable= false;
            },
            OpenCart()
            {
                this.cartVisable = true;
                this.buyBtnVisable= true;
            },
            PutCart(mfruitUnit)
            {
                console.log("æ·»åŠ åˆ°è´­ç‰©è½¦")
                let mcartUnits = this.cartUnits;
                for(let i =0;i<mcartUnits.length;i++)
                {
                    if(mcartUnits[i].data.fno === mfruitUnit.fno)
                    {
                        mcartUnits[i].count++;
                        return;
                    }
                }

                mcartUnits.push({
                   data:mfruitUnit,
                   count:1
                });

            },
            Buy()
            {
                axios({
                    url:"buy",
                    method:'post',
                    data:
                        {
                            buyUnits:this.cartUnits
                        }
                })
                    .then((result) => {
                        //TODO
                    }).catch((err) => {
                    console.log("è¯·æ±‚æäº¤è®¢å•--å‡ºé”™äº†");
                    console.log(err);
                });

                alert("æäº¤è®¢å•æˆåŠŸ,å…±"+this.cartUnits.length+"ç§æ°´æœğŸ‰");
            },
            GetAllBooks()
            {
                axios({
                    url:"getallfruit",
                    method:'get',
                    data: {}
                })
                .then((result) => {
                        let data = result.data;
                        this.fruitUnits = data;
                })
                .catch((err) => {
                    console.log("è·å–æ‰€æœ‰æ°´æœå‡ºé”™äº†");
                    console.log(err);
                });
            }
        },
        watch: {
            cartUnits(newcartUnits, oldcartUnits)
            {
                console.log("è´­ç‰©è½¦æ•°æ®æœ‰å˜åŒ–,é‡æ–°è®¡ç®—æ€»ä»·æ ¼");

                this.totalOrderPrice = 0;

                for(let i = 0; i < newcartUnits.length; i++)
                {
                    this.totalOrderPrice = this.totalOrderPrice + this.cartUnits[i].bprice;
                }
            }
        }

    });

    fruitshopapp.mount("#fruitshopapp");

</script>
</body>

</html>